<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeSource-Lite - Full Prototype</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; }
        :root { --primary: #1a73e8; --success: #34a853; --warning: #fbbc04; --danger: #ea4335; --orange: #ff6d00; --purple: #7c3aed; --gray-100: #f8f9fa; --gray-200: #e9ecef; --gray-300: #dee2e6; --gray-500: #6c757d; --gray-700: #495057; --gray-900: #212529; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; }
        .app-selector { display: flex; background: #1a1a2e; padding: 8px; gap: 6px; overflow-x: auto; position: sticky; top: 0; z-index: 100; }
        .app-tab { padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; white-space: nowrap; color: #888; border: none; background: transparent; transition: all 0.2s; }
        .app-tab:hover { background: rgba(255,255,255,0.1); color: #aaa; }
        .app-tab.active { background: var(--primary); color: white; }
        .app-header { padding: 16px; display: flex; align-items: center; gap: 12px; color: white; }
        .app-header h1 { font-size: 18px; font-weight: 500; flex: 1; }
        .app-header button { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; }
        .search-bar { padding: 12px 16px; background: white; border-bottom: 1px solid var(--gray-200); position: relative; }
        .search-input { width: 100%; padding: 10px 16px 10px 40px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; background: var(--gray-100); }
        .search-icon { position: absolute; left: 28px; top: 50%; transform: translateY(-50%); color: var(--gray-500); }
        .app-content { padding: 12px; background: var(--gray-100); min-height: calc(100vh - 220px); padding-bottom: 80px; }
        .bottom-nav { display: flex; background: white; border-top: 1px solid var(--gray-200); position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; z-index: 50; }
        .nav-item { flex: 1; padding: 10px 4px; text-align: center; cursor: pointer; color: var(--gray-500); font-size: 10px; border: none; background: none; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { display: block; font-size: 18px; margin-bottom: 2px; }
        .card { background: white; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; }
        .card-header { padding: 12px 16px; border-bottom: 1px solid var(--gray-200); font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .list-item { display: flex; padding: 12px 16px; border-bottom: 1px solid var(--gray-100); cursor: pointer; align-items: center; gap: 12px; }
        .list-item:hover { background: var(--gray-100); }
        .list-item:last-child { border-bottom: none; }
        .list-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
        .list-content { flex: 1; min-width: 0; }
        .list-title { font-weight: 500; font-size: 14px; }
        .list-subtitle { font-size: 12px; color: var(--gray-500); margin-top: 2px; }
        .list-meta { text-align: right; }
        .list-price { font-weight: 600; font-size: 14px; }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: 500; display: inline-block; }
        .badge-available { background: #e8f5e9; color: #2e7d32; }
        .badge-pending { background: #fff8e1; color: #f57f17; }
        .badge-complete { background: #e8f5e9; color: #2e7d32; }
        .badge-urgent { background: #ffebee; color: #c62828; }
        .badge-transit { background: #e1f5fe; color: #0277bd; }
        .badge-approved { background: #e3f2fd; color: #1565c0; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
        .stat-card { background: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-label { font-size: 11px; color: var(--gray-500); margin-top: 4px; }
        .section-header { padding: 8px 4px; font-size: 12px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-outline { background: white; border: 1px solid var(--gray-300); color: var(--gray-700); }
        .btn-sm { padding: 6px 10px; font-size: 12px; }
        .btn-block { width: 100%; }
        .fab { position: fixed; bottom: 80px; right: calc(50% - 220px); width: 56px; height: 56px; border-radius: 16px; background: var(--primary); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(26,115,232,0.4); z-index: 40; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: white; border-radius: 16px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 16px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 1; }
        .modal-header h2 { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-500); }
        .modal-body { padding: 16px; }
        .modal-footer { padding: 16px; border-top: 1px solid var(--gray-200); display: flex; gap: 12px; position: sticky; bottom: 0; background: white; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 500; color: var(--gray-700); margin-bottom: 6px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; font-family: inherit; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,115,232,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .inner-tabs { display: flex; background: white; border-bottom: 1px solid var(--gray-200); overflow-x: auto; }
        .inner-tab { flex: 1; padding: 12px 8px; text-align: center; font-size: 12px; font-weight: 500; color: var(--gray-500); cursor: pointer; border: none; background: none; border-bottom: 2px solid transparent; white-space: nowrap; }
        .inner-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; font-size: 13px; }
        .alert-warning { background: #fff8e1; color: #f57f17; }
        .alert-success { background: #e8f5e9; color: #2e7d32; }
        .alert-danger { background: #ffebee; color: #c62828; }
        .alert-info { background: #e3f2fd; color: #1565c0; }
        .route-stop { display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--gray-100); }
        .stop-number { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        .progress-bar { height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .detail-header { padding: 24px; text-align: center; color: white; margin: -16px -16px 16px -16px; }
        .detail-price { font-size: 32px; font-weight: 700; }
        .commission-box { background: #e8f5e9; padding: 16px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .action-buttons { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-500); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 2000; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-100); }
        .info-row:last-child { border-bottom: none; }
        .signature-pad { border: 2px dashed var(--gray-300); border-radius: 8px; height: 100px; display: flex; align-items: center; justify-content: center; color: var(--gray-500); cursor: pointer; background: var(--gray-100); }
        .signature-pad.signed { background: #e8f5e9; border-color: var(--success); color: var(--success); }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, createContext, useContext } = React;

// Initial Data Store
const initialData = {
    locations: [
        { id: 'loc1', code: 'SPRING', name: 'Spring Showroom', phone: '(281) 555-0100', address: '123 Spring Cypress Rd, Spring, TX 77379' },
        { id: 'loc2', code: '45WH', name: '45 Warehouse', phone: '(281) 555-0200', address: '456 Industrial Blvd, Houston, TX 77037' },
        { id: 'loc3', code: 'HEMP', name: 'Hempstead Outlet', phone: '(281) 555-0300', address: '789 Hempstead Hwy, Houston, TX 77092' },
    ],
    users: [
        { id: 'u1', name: 'Brian Nguyen', role: 'Sales', location: 'loc1', email: 'brian@aotx.com', phone: '(281) 555-1001' },
        { id: 'u2', name: 'Carlos Martinez', role: 'Sales', location: 'loc1', email: 'carlos@aotx.com', phone: '(281) 555-1002' },
        { id: 'u3', name: 'Mike Torres', role: 'Driver', location: 'loc2', email: 'mike@aotx.com', phone: '(281) 555-1003' },
        { id: 'u4', name: 'Jessica Taylor', role: 'Warehouse', location: 'loc2', email: 'jessica@aotx.com', phone: '(281) 555-1004' },
        { id: 'u5', name: 'Admin User', role: 'Admin', location: 'loc1', email: 'admin@aotx.com', phone: '(281) 555-1005' },
        { id: 'u6', name: 'Sarah Wilson', role: 'Technician', location: 'loc2', email: 'sarah@aotx.com', phone: '(281) 555-1006' },
    ],
    customers: [
        { id: 'c1', name: 'John Smith', phone: '(713) 555-1234', email: 'john.smith@email.com', address: '456 Oak Ave, Houston, TX 77001' },
        { id: 'c2', name: 'Maria Garcia', phone: '(281) 555-5678', email: 'maria.g@email.com', address: '789 Pine St, Spring, TX 77379' },
        { id: 'c3', name: 'Robert Johnson', phone: '(832) 555-9012', email: 'rjohnson@email.com', address: '321 Elm Dr, Cypress, TX 77429' },
    ],
    inventory: [
        { id: 'inv1', brand: 'Samsung', model: 'RF28T5001SR', desc: '28 cu.ft French Door Refrigerator', condition: 'NEW', price: 1299, cost: 950, msrp: 1799, location: 'loc1', status: 'Available', serial: 'SN-SAM-001', category: 'Refrigerator', color: 'Stainless Steel' },
        { id: 'inv2', brand: 'Samsung', model: 'RF28T5001SR', desc: '28 cu.ft French Door Refrigerator', condition: 'SD-A', price: 999, cost: 750, msrp: 1799, location: 'loc1', status: 'Available', serial: 'SN-SAM-002', category: 'Refrigerator', color: 'Stainless Steel' },
        { id: 'inv3', brand: 'LG', model: 'WM4000HWA', desc: '4.5 cu.ft Front Load Washer', condition: 'NEW', price: 799, cost: 580, msrp: 999, location: 'loc1', status: 'Available', serial: 'SN-LG-001', category: 'Washer', color: 'White' },
        { id: 'inv4', brand: 'LG', model: 'DLEX4000W', desc: '7.4 cu.ft Electric Dryer', condition: 'SD-B', price: 599, cost: 420, msrp: 899, location: 'loc2', status: 'Available', serial: 'SN-LG-002', category: 'Dryer', color: 'White' },
        { id: 'inv5', brand: 'Whirlpool', model: 'WRS325SDHZ', desc: '25 cu.ft Side-by-Side Refrigerator', condition: 'NEW', price: 1099, cost: 800, msrp: 1499, location: 'loc2', status: 'Available', serial: 'SN-WP-001', category: 'Refrigerator', color: 'Stainless Steel' },
        { id: 'inv6', brand: 'GE', model: 'JB645RKSS', desc: '30" Electric Range', condition: 'SD-C', price: 449, cost: 320, msrp: 799, location: 'loc3', status: 'Available', serial: 'SN-GE-001', category: 'Range', color: 'Stainless Steel' },
        { id: 'inv7', brand: 'Bosch', model: 'SHPM88Z75N', desc: '24" Dishwasher 800 Series', condition: 'OPEN', price: 899, cost: 680, msrp: 1199, location: 'loc1', status: 'Available', serial: 'SN-BSH-001', category: 'Dishwasher', color: 'Stainless Steel' },
        { id: 'inv8', brand: 'Electrolux', model: 'ELFW7637AW', desc: '4.5 cu.ft Front Load Washer', condition: 'AS-IS', price: 399, cost: 280, msrp: 999, location: 'loc2', status: 'Available', serial: 'SN-ELX-001', category: 'Washer', color: 'White' },
        { id: 'inv9', brand: 'Frigidaire', model: 'FFSS2615TS', desc: '26 cu.ft Side-by-Side Refrigerator', condition: 'NEW', price: 949, cost: 700, msrp: 1299, location: 'loc3', status: 'Available', serial: 'SN-FRG-001', category: 'Refrigerator', color: 'Stainless Steel' },
        { id: 'inv10', brand: 'Maytag', model: 'MVW7232HW', desc: '5.3 cu.ft Top Load Washer', condition: 'SD-A', price: 649, cost: 480, msrp: 899, location: 'loc1', status: 'Available', serial: 'SN-MAY-001', category: 'Washer', color: 'White' },
    ],
    orders: [
        { id: 'ord1', number: 'ORD-1001', customerId: 'c1', date: '2025-11-28', items: ['inv1', 'inv3'], subtotal: 2098, tax: 173.09, total: 2271.09, status: 'Complete', paid: true, locationId: 'loc1', salesId: 'u1', deliveryType: 'Delivery', deliveryFee: 100, notes: '' },
        { id: 'ord2', number: 'ORD-1002', customerId: 'c2', date: '2025-11-29', items: ['inv2'], subtotal: 999, tax: 82.42, total: 1081.42, status: 'Pending Payment', paid: false, locationId: 'loc1', salesId: 'u1', deliveryType: 'Pickup', deliveryFee: 0, notes: '' },
        { id: 'ord3', number: 'ORD-1003', customerId: 'c3', date: '2025-11-30', items: ['inv5', 'inv6', 'inv7'], subtotal: 2447, tax: 201.88, total: 2798.88, status: 'Pending Delivery', paid: true, locationId: 'loc3', salesId: 'u2', deliveryType: 'White Glove', deliveryFee: 150, notes: '3rd floor apartment' },
    ],
    transferRequests: [
        { id: 'tr1', inventoryId: 'inv4', fromLocation: 'loc2', toLocation: 'loc1', requestedBy: 'u1', date: '2025-11-30', status: 'Pending', reason: 'Customer request', neededBy: '2025-12-02' },
    ],
    deliveryRequests: [
        { id: 'del1', orderId: 'ord3', customerId: 'c3', requestedBy: 'u2', date: '2025-11-30', neededBy: '2025-12-02', status: 'Pending', type: 'White Glove', haulAway: true, notes: '3rd floor apartment', timeWindow: 'Morning' },
    ],
    routes: [
        { id: 'rt1', number: 'RT-201', name: 'North Houston', date: '2025-12-01', driverId: 'u3', truckId: 'TRK-001', status: 'In Progress', stops: [
            { id: 'st1', type: 'Transfer Pickup', locationId: 'loc2', address: '45 Warehouse', status: 'Complete', completedAt: '8:30 AM', signature: true },
            { id: 'st2', type: 'Delivery', orderId: 'ord1', customerId: 'c1', address: '456 Oak Ave, Houston', status: 'Complete', completedAt: '10:15 AM', signature: true },
            { id: 'st3', type: 'Delivery', orderId: 'ord3', customerId: 'c3', address: '321 Elm Dr, Cypress', status: 'Pending', eta: '1:30 PM', signature: false },
        ]},
    ],
    workOrders: [
        { id: 'wo1', number: 'WO-2001', inventoryId: 'inv4', customerId: 'c1', orderId: 'ord1', type: 'Warranty Repair', problem: 'Not heating properly', status: 'Parts Ordered', technicianId: 'u6', parts: ['Heating Element', 'Thermal Fuse'], laborHours: 0, laborRate: 75, createdAt: '2025-11-28', scheduledDate: '2025-12-03', notes: 'Customer reported issue after 2 weeks' },
    ],
    exchanges: [
        { id: 'ex1', number: 'EXC-1001', orderId: 'ord1', originalInventoryId: 'inv1', customerId: 'c1', reason: 'Defective', status: 'Item Selected', replacementInventoryId: 'inv2', notes: 'Compressor not cooling', priceDifference: -300, createdAt: '2025-11-29' },
    ],
    returns: [
        { id: 'ret1', number: 'RET-3001', orderId: 'ord2', inventoryId: 'inv6', customerId: 'c2', reason: 'Changed Mind', status: 'Pending Approval', originalPrice: 449, refundAmount: 381.65, restockingFee: 67.35, restockingPercent: 15, canResell: true, createdAt: '2025-11-30', notes: '' },
    ],
    customOrders: [
        { id: 'co1', number: 'CO-1001', customerId: 'c2', category: 'FURNITURE_SOFA', manufacturer: 'Ashley', item: 'Darcy 3-Piece Sectional', description: 'Gray fabric sectional with chaise', price: 1499, depositPercent: 50, depositAmount: 749.50, depositPaid: true, status: 'Pending Approval', salesId: 'u1', createdAt: '2025-11-30', estimatedDelivery: '2025-12-20', notes: '' },
    ],
    purchaseOrders: [
        { id: 'po1', number: 'PO-LG10272025A', vendor: 'LG Electronics', vendorContact: 'vendor@lg.com', items: [{ model: 'LSGL6335Z', desc: 'Gas Range', qty: 15, price: 831 }, { model: 'MVEL2033D', desc: 'Electric Dryer', qty: 10, price: 225.75 }], subtotal: 14722.50, shipping: 480, total: 15202.50, status: 'Pending', shipTo: 'loc2', createdAt: '2025-10-27', expectedDate: '2025-12-05', notes: '' },
    ],
    activityLog: [
        { id: 'act1', action: 'Order Completed', entity: 'Order', entityId: 'ord1', details: 'ORD-1001 marked complete', userId: 'u1', timestamp: '2025-11-28 14:30:00' },
        { id: 'act2', action: 'Customer Created', entity: 'Customer', entityId: 'c3', details: 'New customer: Robert Johnson', userId: 'u1', timestamp: '2025-11-30 09:15:00' },
        { id: 'act3', action: 'Inventory Received', entity: 'Inventory', entityId: 'inv9', details: '15 items from Whirlpool', userId: 'u4', timestamp: '2025-11-29 11:00:00' },
        { id: 'act4', action: 'Transfer Requested', entity: 'Transfer', entityId: 'tr1', details: 'LG DLEX4000W: 45WH → SPRING', userId: 'u1', timestamp: '2025-11-30 10:00:00' },
    ],
};

const commissionRates = { 'NEW': 8, 'SD-A': 10, 'SD-B': 12, 'SD-C': 14, 'SD-D': 15, 'OPEN': 10, 'REFURB': 10, 'AS-IS': 5, 'CLEARANCE': 6 };
const conditionLabels = { 'NEW': 'Factory New', 'SD-A': 'Scratch & Dent A', 'SD-B': 'Scratch & Dent B', 'SD-C': 'Scratch & Dent C', 'SD-D': 'Scratch & Dent D', 'OPEN': 'Open Box', 'REFURB': 'Refurbished', 'AS-IS': 'As-Is', 'CLEARANCE': 'Clearance' };
const categories = ['Refrigerator', 'Washer', 'Dryer', 'Range', 'Dishwasher', 'Microwave', 'Freezer'];
const conditions = ['NEW', 'SD-A', 'SD-B', 'SD-C', 'SD-D', 'OPEN', 'REFURB', 'AS-IS', 'CLEARANCE'];
const customOrderCategories = ['FURNITURE_SOFA', 'FURNITURE_DINING', 'FURNITURE_BEDROOM', 'FURNITURE_MATTRESS', 'APPLIANCE_BUILTIN', 'APPLIANCE_PANEL', 'SPECIAL_ORDER'];

// Context
const AppContext = createContext();
const useApp = () => useContext(AppContext);

// Utility Components
const Toast = ({ message, onClose }) => {
    useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, []);
    return <div className="toast">{message}</div>;
};

const Modal = ({ title, children, onClose, footer }) => (
    <div className="modal-overlay" onClick={onClose}>
        <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
                <h2>{title}</h2>
                <button className="modal-close" onClick={onClose}>&times;</button>
            </div>
            <div className="modal-body">{children}</div>
            {footer && <div className="modal-footer">{footer}</div>}
        </div>
    </div>
);

const StatusBadge = ({ status }) => {
    const map = { 'Available': 'available', 'Complete': 'complete', 'Pending': 'pending', 'Pending Payment': 'pending', 'Pending Delivery': 'transit', 'Pending Approval': 'pending', 'In Progress': 'transit', 'Parts Ordered': 'pending', 'Item Selected': 'approved', 'Approved': 'approved', 'In Transit': 'transit', 'Allocated': 'pending', 'Ready for Pickup': 'approved', 'Sold': 'complete', 'Scheduled': 'approved', 'Received': 'complete' };
    return <span className={`badge badge-${map[status] || 'pending'}`}>{status}</span>;
};

const FormInput = ({ label, id, type = 'text', required, ...props }) => (
    <div className="form-group">
        <label className="form-label">{label}{required && ' *'}</label>
        {type === 'textarea' ? <textarea className="form-textarea" id={id} rows="3" {...props}></textarea> :
         type === 'select' ? <select className="form-select" id={id} {...props}>{props.children}</select> :
         <input className="form-input" id={id} type={type} {...props} />}
    </div>
);

// ============ SALES POS APP ============
const SalesPOS = () => {
    const { data, setData, showToast, currentUser, addActivity } = useApp();
    const [view, setView] = useState('home');
    const [modal, setModal] = useState(null);
    const [search, setSearch] = useState('');
    const [cart, setCart] = useState([]);
    const [selectedCustomer, setSelectedCustomer] = useState(null);
    const [editItem, setEditItem] = useState(null);
    // Linear POS flow state
    const [posStep, setPosStep] = useState(null); // null, 'customer', 'items', 'payment', 'rog'
    const [posCustomer, setPosCustomer] = useState(null);
    const [posCart, setPosCart] = useState([]);
    const [posPaymentMethod, setPosPaymentMethod] = useState('Cash');
    const [posRogFile, setPosRogFile] = useState(null);
    // Inventory search state
    const [inventoryFilters, setInventoryFilters] = useState({ brand: '', category: '', location: '', condition: '', priceMin: '', priceMax: '' });
    const [barcodeInput, setBarcodeInput] = useState('');
    const [showBarcodeScanner, setShowBarcodeScanner] = useState(false);
    const [barcodeResult, setBarcodeResult] = useState(null);

    const getLocation = (id) => data.locations.find(l => l.id === id);
    const getCustomer = (id) => data.customers.find(c => c.id === id);
    const getInventory = (id) => data.inventory.find(i => i.id === id);
    
    const myOrders = data.orders.filter(o => o.salesId === currentUser.id);
    const completedOrders = myOrders.filter(o => o.status === 'Complete');
    const todaySales = completedOrders.reduce((sum, o) => sum + o.total, 0);
    const myCommission = completedOrders.reduce((sum, o) => sum + o.items.reduce((s, invId) => {
        const inv = data.inventory.find(i => i.id === invId);
        return s + (inv ? inv.price * (commissionRates[inv.condition] || 10) / 100 : 0);
    }, 0), 0);
    
    const availableInventory = data.inventory.filter(i => i.status === 'Available');
    const filteredInventory = availableInventory.filter(i => 
        !search || i.brand.toLowerCase().includes(search.toLowerCase()) || 
        i.model.toLowerCase().includes(search.toLowerCase()) ||
        i.desc.toLowerCase().includes(search.toLowerCase()) ||
        i.serial.toLowerCase().includes(search.toLowerCase())
    );

    const addToCart = (item) => {
        if (cart.find(c => c.id === item.id)) return showToast('Already in cart');
        setCart([...cart, item]);
        setData(d => ({ ...d, inventory: d.inventory.map(i => i.id === item.id ? { ...i, status: 'Allocated' } : i) }));
        showToast('Added to cart');
    };

    const removeFromCart = (itemId) => {
        setCart(cart.filter(c => c.id !== itemId));
        setData(d => ({ ...d, inventory: d.inventory.map(i => i.id === itemId ? { ...i, status: 'Available' } : i) }));
    };

    const createOrder = (formData) => {
        if (!selectedCustomer) return showToast('Select customer first');
        if (cart.length === 0) return showToast('Cart is empty');
        
        const subtotal = cart.reduce((s, i) => s + i.price, 0);
        const tax = subtotal * 0.0825;
        const deliveryFee = formData.deliveryType === 'Pickup' ? 0 : formData.deliveryType === 'Delivery' ? 75 : 150;
        const total = subtotal + tax + deliveryFee;
        
        const newOrder = {
            id: `ord${Date.now()}`,
            number: `ORD-${1004 + data.orders.length}`,
            customerId: selectedCustomer.id,
            date: new Date().toISOString().split('T')[0],
            items: cart.map(c => c.id),
            subtotal, tax, total,
            status: 'Pending Payment',
            paid: false,
            locationId: currentUser.location,
            salesId: currentUser.id,
            deliveryType: formData.deliveryType,
            deliveryFee,
            notes: formData.notes || ''
        };
        
        setData(d => ({
            ...d,
            orders: [...d.orders, newOrder],
            inventory: d.inventory.map(i => cart.find(c => c.id === i.id) ? { ...i, status: 'Sold' } : i)
        }));
        addActivity('Order Created', 'Order', newOrder.id, `${newOrder.number} - $${total.toFixed(2)}`);
        
        setCart([]);
        setSelectedCustomer(null);
        setModal(null);
        setView('orders');
        showToast(`Order ${newOrder.number} created!`);
    };

    const markOrderPaid = (orderId) => {
        const order = data.orders.find(o => o.id === orderId);
        const newStatus = order.deliveryType === 'Pickup' ? 'Ready for Pickup' : 'Pending Delivery';
        setData(d => ({ ...d, orders: d.orders.map(o => o.id === orderId ? { ...o, paid: true, status: newStatus } : o) }));
        addActivity('Payment Received', 'Order', orderId, `${order.number} paid`);
        showToast('Payment recorded');
    };

    const createCustomer = (formData) => {
        if (!formData.name || !formData.phone) return showToast('Name and phone required');
        const newCust = { id: `c${Date.now()}`, ...formData };
        setData(d => ({ ...d, customers: [...d.customers, newCust] }));
        addActivity('Customer Created', 'Customer', newCust.id, newCust.name);
        setSelectedCustomer(newCust);
        setModal(null);
        showToast('Customer created');
    };

    const updateCustomer = (custId, formData) => {
        setData(d => ({ ...d, customers: d.customers.map(c => c.id === custId ? { ...c, ...formData } : c) }));
        showToast('Customer updated');
        setModal(null);
    };

    const createTransferRequest = (formData) => {
        const item = data.inventory.find(i => i.id === formData.inventoryId);
        const newTr = {
            id: `tr${Date.now()}`,
            inventoryId: formData.inventoryId,
            fromLocation: item.location,
            toLocation: formData.toLocation,
            requestedBy: currentUser.id,
            date: new Date().toISOString().split('T')[0],
            status: 'Pending',
            reason: formData.reason,
            neededBy: formData.neededBy
        };
        setData(d => ({ ...d, transferRequests: [...d.transferRequests, newTr] }));
        addActivity('Transfer Requested', 'Transfer', newTr.id, `${item.brand} ${item.model}: ${getLocation(item.location)?.code} → ${getLocation(formData.toLocation)?.code}`);
        setModal(null);
        showToast('Transfer request created');
    };

    const cartSubtotal = cart.reduce((s, i) => s + i.price, 0);
    const cartTax = cartSubtotal * 0.0825;

    // Linear POS Flow Handlers
    const startPosFlow = () => {
        setPosStep('customer');
        setPosCustomer(null);
        setPosCart([]);
        setPosPaymentMethod('Cash');
        setPosRogFile(null);
        setView('home');
    };

    const proceedToItemSelection = () => {
        if (!posCustomer) return showToast('Please select or create a customer');
        setPosStep('items');
    };

    const addItemToPosCart = (item) => {
        if (posCart.find(c => c.id === item.id)) {
            return showToast('Item already in cart');
        }
        setPosCart([...posCart, item]);
        showToast('Item added to cart');
    };

    const removeItemFromPosCart = (itemId) => {
        setPosCart(posCart.filter(i => i.id !== itemId));
    };

    const proceedToPayment = () => {
        if (posCart.length === 0) return showToast('Add at least one item');
        setPosStep('payment');
    };

    const proceedToRog = () => {
        setPosStep('rog');
    };

    const completePosOrder = () => {
        const subtotal = posCart.reduce((s, i) => s + i.price, 0);
        const tax = subtotal * 0.0825;
        const total = subtotal + tax;

        const newOrder = {
            id: `ord${Date.now()}`,
            number: `ORD-${1004 + data.orders.length}`,
            customerId: posCustomer.id,
            date: new Date().toISOString().split('T')[0],
            items: posCart.map(c => c.id),
            subtotal,
            tax,
            total,
            status: 'Complete',
            paid: true,
            locationId: currentUser.location,
            salesId: currentUser.id,
            deliveryType: 'Pickup',
            deliveryFee: 0,
            notes: `Payment: ${posPaymentMethod}${posRogFile ? ' | ROG uploaded' : ''}`
        };

        setData(d => ({
            ...d,
            orders: [...d.orders, newOrder],
            inventory: d.inventory.map(i => posCart.find(c => c.id === i.id) ? { ...i, status: 'Sold' } : i)
        }));
        addActivity('POS Order', 'Order', newOrder.id, `${newOrder.number} - $${total.toFixed(2)}`);

        showToast(`Order ${newOrder.number} complete!`);
        setPosStep(null);
        setView('home');
    };

    if (posStep === 'customer') {
        return (
            <div>
                <div className="app-header" style={{background: 'var(--primary)'}}>
                    <div className="list-icon" style={{background:'rgba(255,255,255,0.2)', color:'white'}}><i className="fas fa-store"></i></div>
                    <h1>POS - Step 1 of 4</h1>
                </div>
                <div className="app-content">
                    <div className="card">
                        <div className="card-header">Select or Create Customer</div>
                        {posCustomer && (
                            <div style={{padding:16,background:'#e8f5e9',borderBottom:'1px solid var(--gray-200)'}}>
                                <div style={{fontSize:14,fontWeight:600,marginBottom:8}}><i className="fas fa-check-circle" style={{color:'var(--success)',marginRight:8}}></i>{posCustomer.name}</div>
                                <div style={{fontSize:12,color:'var(--gray-700)'}}>{posCustomer.phone}</div>
                                <button className="btn btn-sm btn-outline" style={{marginTop:8}} onClick={() => setPosCustomer(null)}>
                                    <i className="fas fa-edit"></i> Change Customer
                                </button>
                            </div>
                        )}
                        {!posCustomer && (
                            <>
                                <div style={{padding:16,borderBottom:'1px solid var(--gray-200)'}}>
                                    <button className="btn btn-primary btn-block" onClick={() => setModal('pos-select-customer')}>
                                        <i className="fas fa-users"></i> Select Existing Customer
                                    </button>
                                </div>
                                <div style={{padding:16}}>
                                    <button className="btn btn-outline btn-block" onClick={() => setModal('pos-new-customer')}>
                                        <i className="fas fa-user-plus"></i> Create New Customer
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                    {posCustomer && (
                        <button className="btn btn-success btn-block" style={{marginTop:16}} onClick={proceedToItemSelection}>
                            <i className="fas fa-arrow-right"></i> Next: Select Items (Step 2)
                        </button>
                    )}
                </div>
                {/* Customer Selection Modal */}
                {modal === 'pos-select-customer' && (
                    <Modal title="Select Customer" onClose={() => setModal(null)}>
                        <div className="card">
                            {data.customers.map(customer => (
                                <div key={customer.id} className="list-item" onClick={() => { setPosCustomer(customer); setModal(null); }}>
                                    <div className="list-icon" style={{background:'#f3e5f5', color:'var(--purple)'}}><i className="fas fa-user"></i></div>
                                    <div className="list-content">
                                        <div className="list-title">{customer.name}</div>
                                        <div className="list-subtitle">{customer.phone}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </Modal>
                )}
                {/* New Customer Modal */}
                {modal === 'pos-new-customer' && (
                    <Modal title="Create New Customer" onClose={() => setModal(null)} footer={
                        <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                            const name = document.getElementById('pos-cust-name').value;
                            const phone = document.getElementById('pos-cust-phone').value;
                            if (!name || !phone) return showToast('Name and phone required');
                            const newCust = { id: `c${Date.now()}`, name, phone, email: document.getElementById('pos-cust-email').value || '', address: document.getElementById('pos-cust-address').value || '' };
                            setData(d => ({ ...d, customers: [...d.customers, newCust] }));
                            setPosCustomer(newCust);
                            setModal(null);
                            showToast('Customer created');
                        }}><i className="fas fa-check"></i> Create Customer</button>
                    }>
                        <FormInput label="Name" id="pos-cust-name" required />
                        <FormInput label="Phone" id="pos-cust-phone" required />
                        <FormInput label="Email" id="pos-cust-email" type="email" />
                        <FormInput label="Address" id="pos-cust-address" type="textarea" />
                    </Modal>
                )}
            </div>
        );
    }

    if (posStep === 'items') {
        const availableInventory = data.inventory.filter(i => i.status === 'Available');
        const filteredInventory = availableInventory.filter(i => 
            !search || i.brand.toLowerCase().includes(search.toLowerCase()) || 
            i.model.toLowerCase().includes(search.toLowerCase()) ||
            i.desc.toLowerCase().includes(search.toLowerCase())
        );
        const posSub = posCart.reduce((s, i) => s + i.price, 0);
        const posTax = posSub * 0.0825;

        return (
            <div>
                <div className="app-header" style={{background: 'var(--primary)'}}>
                    <div className="list-icon" style={{background:'rgba(255,255,255,0.2)', color:'white'}}><i className="fas fa-store"></i></div>
                    <h1>POS - Step 2 of 4</h1>
                    {posCart.length > 0 && (
                        <span className="cart-badge">{posCart.length}</span>
                    )}
                </div>
                <div className="search-bar">
                    <i className="fas fa-search search-icon"></i>
                    <input className="search-input" placeholder="Search inventory..." value={search} onChange={e => setSearch(e.target.value)} />
                </div>
                <div className="app-content">
                    <div className="alert alert-info"><i className="fas fa-user"></i> Customer: {posCustomer?.name}</div>
                    {posCart.length > 0 && (
                        <div className="card" style={{marginBottom:16}}>
                            <div className="card-header">Items in Cart ({posCart.length})</div>
                            {posCart.map(item => (
                                <div key={item.id} className="list-item">
                                    <div className="list-content">
                                        <div className="list-title">{item.brand} {item.model}</div>
                                        <div className="list-subtitle">{conditionLabels[item.condition]}</div>
                                    </div>
                                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                                        <span>${item.price}</span>
                                        <button className="btn btn-sm btn-danger" onClick={() => removeItemFromPosCart(item.id)}><i className="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            ))}
                            <div style={{padding:16,background:'var(--gray-100)',borderTop:'1px solid var(--gray-200)'}}>
                                <div className="info-row"><span>Subtotal:</span><strong>${posSub.toFixed(2)}</strong></div>
                                <div className="info-row"><span>Tax (8.25%):</span><strong>${posTax.toFixed(2)}</strong></div>
                                <div className="info-row" style={{fontSize:16}}><strong>Total:</strong><strong>${(posSub + posTax).toFixed(2)}</strong></div>
                            </div>
                        </div>
                    )}
                    {filteredInventory.length === 0 ? (
                        <div className="empty-state"><i className="fas fa-box-open"></i><p>No items available</p></div>
                    ) : (
                        <div className="card">
                            {filteredInventory.map(item => (
                                <div key={item.id} className="list-item" onClick={() => addItemToPosCart(item)}>
                                    <div className="list-icon" style={{background:'#e3f2fd', color:'var(--primary)'}}><i className="fas fa-cube"></i></div>
                                    <div className="list-content">
                                        <div className="list-title">{item.brand} {item.model}</div>
                                        <div className="list-subtitle">{conditionLabels[item.condition]} • ${item.price}</div>
                                    </div>
                                    <div style={{textAlign:'right'}}>
                                        <button className="btn btn-sm btn-primary"><i className="fas fa-plus"></i></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                <div style={{padding:12,background:'white',borderTop:'1px solid var(--gray-200)',display:'flex',gap:8}}>
                    <button className="btn btn-outline btn-block" onClick={() => setPosStep('customer')}><i className="fas fa-arrow-left"></i> Back</button>
                    <button className="btn btn-success btn-block" onClick={proceedToPayment} disabled={posCart.length === 0}>
                        <i className="fas fa-arrow-right"></i> Next: Payment (Step 3)
                    </button>
                </div>
            </div>
        );
    }

    if (posStep === 'payment') {
        const posSub = posCart.reduce((s, i) => s + i.price, 0);
        const posTax = posSub * 0.0825;
        const posTotal = posSub + posTax;

        return (
            <div>
                <div className="app-header" style={{background: 'var(--primary)'}}>
                    <div className="list-icon" style={{background:'rgba(255,255,255,0.2)', color:'white'}}><i className="fas fa-store"></i></div>
                    <h1>POS - Step 3 of 4: Payment</h1>
                </div>
                <div className="app-content">
                    <div className="card" style={{marginBottom:16}}>
                        <div className="card-header">Order Summary</div>
                        <div style={{padding:16}}>
                            <div className="info-row"><span>Customer:</span><strong>{posCustomer?.name}</strong></div>
                            <div className="info-row"><span>Items:</span><strong>{posCart.length}</strong></div>
                            <div className="info-row"><span>Subtotal:</span><strong>${posSub.toFixed(2)}</strong></div>
                            <div className="info-row"><span>Tax (8.25%):</span><strong>${posTax.toFixed(2)}</strong></div>
                            <div className="info-row" style={{fontSize:18,fontWeight:700,borderTop:'2px solid var(--gray-300)',paddingTop:8,marginTop:8}}>
                                <span>Total:</span><strong style={{color:'var(--primary)'}}>${posTotal.toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                    <div className="card">
                        <div className="card-header">Payment Method</div>
                        <div style={{padding:16}}>
                            <FormInput label="Method" type="select" defaultValue="Cash" onChange={e => setPosPaymentMethod(e.target.value)} id="pos-payment-method">
                                <option>Cash</option>
                                <option>Credit Card</option>
                                <option>Debit Card</option>
                                <option>Check</option>
                                <option>Bank Transfer</option>
                            </FormInput>
                        </div>
                    </div>
                </div>
                <div style={{padding:12,background:'white',borderTop:'1px solid var(--gray-200)',display:'flex',gap:8}}>
                    <button className="btn btn-outline btn-block" onClick={() => setPosStep('items')}><i className="fas fa-arrow-left"></i> Back</button>
                    <button className="btn btn-success btn-block" onClick={proceedToRog}>
                        <i className="fas fa-arrow-right"></i> Next: ROG Upload (Step 4)
                    </button>
                </div>
            </div>
        );
    }

    if (posStep === 'rog') {
        return (
            <div>
                <div className="app-header" style={{background: 'var(--primary)'}}>
                    <div className="list-icon" style={{background:'rgba(255,255,255,0.2)', color:'white'}}><i className="fas fa-store"></i></div>
                    <h1>POS - Step 4 of 4: ROG Upload</h1>
                </div>
                <div className="app-content">
                    <div className="card" style={{marginBottom:16}}>
                        <div className="card-header">Receipt of Goods (ROG) File</div>
                        <div style={{padding:16}}>
                            <div className="signature-pad" onClick={() => document.getElementById('pos-rog-file').click()} style={{cursor:'pointer'}}>
                                {posRogFile ? (
                                    <div style={{textAlign:'center',color:'var(--success)'}}>
                                        <i className="fas fa-check-circle" style={{fontSize:32,marginBottom:8,display:'block'}}></i>
                                        <strong>{posRogFile}</strong><br/><small>Ready to upload</small>
                                    </div>
                                ) : (
                                    <div style={{textAlign:'center'}}>
                                        <i className="fas fa-cloud-upload-alt" style={{fontSize:32,marginBottom:8,display:'block'}}></i>
                                        <strong>Click to upload ROG file</strong><br/><small>PDF, Image, or Document</small>
                                    </div>
                                )}
                            </div>
                            <input type="file" id="pos-rog-file" style={{display:'none'}} accept=".pdf,.jpg,.png,.doc,.docx" onChange={e => setPosRogFile(e.target.files[0]?.name || 'Unknown')} />
                        </div>
                    </div>
                    <div className="alert alert-info"><i className="fas fa-info-circle"></i> ROG files are optional but recommended for documentation</div>
                </div>
                <div style={{padding:12,background:'white',borderTop:'1px solid var(--gray-200)',display:'flex',gap:8}}>
                    <button className="btn btn-outline btn-block" onClick={() => setPosStep('payment')}><i className="fas fa-arrow-left"></i> Back</button>
                    <button className="btn btn-success btn-block" onClick={completePosOrder}>
                        <i className="fas fa-check-circle"></i> Complete Order
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div>
            <div className="app-header" style={{background: 'var(--primary)'}}>
                <div className="list-icon" style={{background:'rgba(255,255,255,0.2)', color:'white'}}><i className="fas fa-store"></i></div>
                <h1>Sales POS</h1>
                <button onClick={startPosFlow} title="Start new order"><i className="fas fa-plus-circle"></i></button>
            </div>

            {view === 'home' && (
                <div className="app-content">
                    <div className="stats-grid">
                        <div className="stat-card"><div className="stat-value" style={{color:'var(--primary)'}}>${todaySales.toFixed(0)}</div><div className="stat-label">Total Sales</div></div>
                        <div className="stat-card"><div className="stat-value" style={{color:'var(--success)'}}>{myOrders.length}</div><div className="stat-label">My Orders</div></div>
                        <div className="stat-card"><div className="stat-value" style={{color:'var(--warning)'}}>${myCommission.toFixed(2)}</div><div className="stat-label">Commission</div></div>
                        <div className="stat-card"><div className="stat-value">{availableInventory.length}</div><div className="stat-label">Available</div></div>
                    </div>

                    <div style={{marginBottom:16}}>
                        <button className="btn btn-success btn-block" onClick={startPosFlow} style={{padding:'16px',fontSize:16}}>
                            <i className="fas fa-cart-plus"></i> Start New POS Order
                        </button>
                    </div>

                    <div className="section-header">
                        Recent Orders
                        <button className="btn btn-sm btn-outline" onClick={() => setView('orders')}>View All</button>
                    </div>
                    <div className="card">
                        {myOrders.length === 0 ? (
                            <div className="empty-state" style={{padding:20}}><p>No orders yet</p></div>
                        ) : myOrders.slice(0, 5).map(order => (
                            <div key={order.id} className="list-item" onClick={() => setModal({ type: 'orderDetail', order })}>
                                <div className="list-icon" style={{background: order.status === 'Complete' ? '#e8f5e9' : '#fff8e1', color: order.status === 'Complete' ? 'var(--success)' : 'var(--warning)'}}>
                                    <i className="fas fa-receipt"></i>
                                </div>
                                <div className="list-content">
                                    <div className="list-title">{order.number} • {getCustomer(order.customerId)?.name}</div>
                                    <div className="list-subtitle">{order.items.length} item(s) • {order.deliveryType}</div>
                                </div>
                                <div className="list-meta">
                                    <div className="list-price">${order.total.toFixed(2)}</div>
                                    <StatusBadge status={order.status} />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {view === 'inventory' && (
                <div>
                    <div className="app-header" style={{background: 'var(--primary)'}}>
                        <div className="list-icon" style={{background:'rgba(255,255,255,0.2)', color:'white'}}><i className="fas fa-box"></i></div>
                        <h1>Inventory Search</h1>
                        <button onClick={() => setShowBarcodeScanner(!showBarcodeScanner)} title="Scan barcode" style={{position:'relative'}}>
                            <i className="fas fa-barcode"></i>
                        </button>
                    </div>

                    {/* Barcode Scanner */}
                    {showBarcodeScanner && (
                        <div style={{padding:12,background:'#fff8e1',borderBottom:'2px solid var(--warning)'}}>
                            <div style={{fontSize:12,fontWeight:600,marginBottom:8,color:'#f57f17'}}><i className="fas fa-barcode"></i> Barcode Scanner Mode</div>
                            <input 
                                type="text" 
                                placeholder="Point camera or enter barcode..." 
                                value={barcodeInput} 
                                onChange={e => {
                                    setBarcodeInput(e.target.value);
                                    // Auto-search for serial/barcode
                                    if (e.target.value.length > 2) {
                                        const match = data.inventory.find(i => i.serial.toLowerCase().includes(e.target.value.toLowerCase()) || i.id.includes(e.target.value));
                                        setBarcodeResult(match || null);
                                    }
                                }}
                                onKeyPress={e => {
                                    if (e.key === 'Enter' && barcodeResult) {
                                        setModal({ type: 'inventoryDetail', item: barcodeResult });
                                        setBarcodeInput('');
                                        setBarcodeResult(null);
                                    }
                                }}
                                autoFocus
                                className="form-input"
                                style={{marginBottom:8}}
                            />
                            {barcodeResult && (
                                <div className="alert alert-success">
                                    <i className="fas fa-check-circle"></i>
                                    <div style={{flex:1}}><strong>{barcodeResult.brand} {barcodeResult.model}</strong><br/><small>SN: {barcodeResult.serial}</small></div>
                                    <button className="btn btn-sm btn-success" onClick={() => {
                                        setModal({ type: 'inventoryDetail', item: barcodeResult });
                                        setBarcodeInput('');
                                        setBarcodeResult(null);
                                    }}>View</button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Advanced Search Filters */}
                    <div style={{padding:12,background:'var(--gray-100)',borderBottom:'1px solid var(--gray-300)'}}>
                        <div style={{fontSize:12,fontWeight:600,marginBottom:12,color:'var(--gray-700)'}}>
                            <i className="fas fa-filter"></i> Search & Filter
                        </div>
                        <div className="form-row">
                            <input 
                                type="text" 
                                placeholder="Brand..." 
                                className="form-input" 
                                value={inventoryFilters.brand}
                                onChange={e => setInventoryFilters({...inventoryFilters, brand: e.target.value})}
                            />
                            <select 
                                className="form-select"
                                value={inventoryFilters.category}
                                onChange={e => setInventoryFilters({...inventoryFilters, category: e.target.value})}
                            >
                                <option value="">All Categories</option>
                                {categories.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>
                        <div className="form-row" style={{marginTop:8}}>
                            <select 
                                className="form-select"
                                value={inventoryFilters.condition}
                                onChange={e => setInventoryFilters({...inventoryFilters, condition: e.target.value})}
                            >
                                <option value="">All Conditions</option>
                                {conditions.map(c => <option key={c} value={c}>{conditionLabels[c]}</option>)}
                            </select>
                            <select 
                                className="form-select"
                                value={inventoryFilters.location}
                                onChange={e => setInventoryFilters({...inventoryFilters, location: e.target.value})}
                            >
                                <option value="">All Locations</option>
                                {data.locations.map(l => <option key={l.id} value={l.id}>{l.code}</option>)}
                            </select>
                        </div>
                        <div className="form-row" style={{marginTop:8}}>
                            <input 
                                type="number" 
                                placeholder="Min Price" 
                                className="form-input"
                                value={inventoryFilters.priceMin}
                                onChange={e => setInventoryFilters({...inventoryFilters, priceMin: e.target.value})}
                            />
                            <input 
                                type="number" 
                                placeholder="Max Price" 
                                className="form-input"
                                value={inventoryFilters.priceMax}
                                onChange={e => setInventoryFilters({...inventoryFilters, priceMax: e.target.value})}
                            />
                        </div>
                        <button 
                            className="btn btn-outline btn-block" 
                            style={{marginTop:8}}
                            onClick={() => setInventoryFilters({ brand: '', category: '', location: '', condition: '', priceMin: '', priceMax: '' })}
                        >
                            <i className="fas fa-times"></i> Clear Filters
                        </button>
                    </div>

                    <div className="search-bar">
                        <i className="fas fa-search search-icon"></i>
                        <input className="search-input" placeholder="Search serial, model..." value={search} onChange={e => setSearch(e.target.value)} />
                    </div>

                    <div className="app-content">
                        {(() => {
                            // Apply all filters
                            let filtered = availableInventory;
                            
                            if (search) {
                                filtered = filtered.filter(i => 
                                    i.brand.toLowerCase().includes(search.toLowerCase()) || 
                                    i.model.toLowerCase().includes(search.toLowerCase()) ||
                                    i.serial.toLowerCase().includes(search.toLowerCase())
                                );
                            }
                            if (inventoryFilters.brand) {
                                filtered = filtered.filter(i => i.brand.toLowerCase().includes(inventoryFilters.brand.toLowerCase()));
                            }
                            if (inventoryFilters.category) {
                                filtered = filtered.filter(i => i.category === inventoryFilters.category);
                            }
                            if (inventoryFilters.condition) {
                                filtered = filtered.filter(i => i.condition === inventoryFilters.condition);
                            }
                            if (inventoryFilters.location) {
                                filtered = filtered.filter(i => i.location === inventoryFilters.location);
                            }
                            if (inventoryFilters.priceMin) {
                                filtered = filtered.filter(i => i.price >= parseFloat(inventoryFilters.priceMin));
                            }
                            if (inventoryFilters.priceMax) {
                                filtered = filtered.filter(i => i.price <= parseFloat(inventoryFilters.priceMax));
                            }

                            return (
                                <>
                                    <div style={{fontSize:12,color:'var(--gray-500)',padding:'12px 16px',background:'var(--gray-100)',borderBottom:'1px solid var(--gray-200)'}}>
                                        <i className="fas fa-info-circle"></i> {filtered.length} items found
                                    </div>
                                    {filtered.length === 0 ? (
                                        <div className="empty-state"><i className="fas fa-box-open"></i><p>No items match your criteria</p></div>
                                    ) : (
                                        <div className="card">
                                            {filtered.map(item => (
                                                <div key={item.id} className="list-item" onClick={() => setModal({ type: 'inventoryDetail', item })}>
                                                    <div className="list-icon" style={{background:'#e3f2fd', color:'var(--primary)'}}><i className="fas fa-cube"></i></div>
                                                    <div className="list-content">
                                                        <div className="list-title">{item.brand} {item.model}</div>
                                                        <div className="list-subtitle">{conditionLabels[item.condition]} • {getLocation(item.location)?.code} • {item.category}</div>
                                                        <div className="list-subtitle" style={{fontSize:10,color:'var(--gray-500)'}}>SN: {item.serial}</div>
                                                    </div>
                                                    <div className="list-meta">
                                                        <div className="list-price">${item.price}</div>
                                                        <div style={{fontSize:11,color:'var(--success)'}}>+${(item.price * commissionRates[item.condition] / 100).toFixed(2)}</div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </>
                            );
                        })()}
                    </div>
                </div>
            )}

            {view === 'orders' && (
                <div className="app-content">
                    <div className="section-header">All Orders</div>
                    <div className="card">
                        {data.orders.map(order => (
                            <div key={order.id} className="list-item" onClick={() => setModal({ type: 'orderDetail', order })}>
                                <div className="list-icon" style={{background:'#e3f2fd', color:'var(--primary)'}}><i className="fas fa-receipt"></i></div>
                                <div className="list-content">
                                    <div className="list-title">{order.number} • {getCustomer(order.customerId)?.name}</div>
                                    <div className="list-subtitle">{order.date} • {order.items.length} item(s)</div>
                                </div>
                                <div className="list-meta">
                                    <div className="list-price">${order.total.toFixed(2)}</div>
                                    <StatusBadge status={order.status} />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {view === 'customers' && (
                <div className="app-content">
                    <div className="section-header">
                        Customers ({data.customers.length})
                        <button className="btn btn-sm btn-primary" onClick={() => setModal('newCustomer')}><i className="fas fa-plus"></i></button>
                    </div>
                    <div className="card">
                        {data.customers.map(customer => (
                            <div key={customer.id} className="list-item" onClick={() => setModal({ type: 'customerDetail', customer })}>
                                <div className="list-icon" style={{background: selectedCustomer?.id === customer.id ? '#e8f5e9' : '#f3e5f5', color: selectedCustomer?.id === customer.id ? 'var(--success)' : 'var(--purple)'}}>
                                    <i className="fas fa-user"></i>
                                </div>
                                <div className="list-content">
                                    <div className="list-title">{customer.name}</div>
                                    <div className="list-subtitle">{customer.phone}</div>
                                </div>
                                <div className="list-meta">
                                    <button className="btn btn-sm btn-outline" onClick={(e) => { e.stopPropagation(); setSelectedCustomer(customer); showToast(`Selected: ${customer.name}`); }}>
                                        {selectedCustomer?.id === customer.id ? <i className="fas fa-check"></i> : 'Select'}
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            <button className="fab" onClick={startPosFlow}>
                <i className="fas fa-plus"></i>
            </button>

            <div className="bottom-nav">
                <button className={`nav-item ${view === 'home' ? 'active' : ''}`} onClick={() => setView('home')}><i className="fas fa-home"></i>Home</button>
                <button className={`nav-item ${view === 'inventory' ? 'active' : ''}`} onClick={() => setView('inventory')}><i className="fas fa-box"></i>Inventory</button>
                <button className={`nav-item ${view === 'orders' ? 'active' : ''}`} onClick={() => setView('orders')}><i className="fas fa-receipt"></i>Orders</button>
                <button className={`nav-item ${view === 'customers' ? 'active' : ''}`} onClick={() => setView('customers')}><i className="fas fa-users"></i>Customers</button>
            </div>

            {/* MODALS */}

            {modal?.type === 'inventoryDetail' && (
                <Modal title="Item Details" onClose={() => setModal(null)} footer={
                    <><button className="btn btn-outline" style={{flex:1}} onClick={() => setModal({ type: 'requestTransfer', item: modal.item })}><i className="fas fa-exchange-alt"></i> Transfer</button>
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => { addToCart(modal.item); setModal(null); }}><i className="fas fa-cart-plus"></i> Add to Cart</button></>
                }>
                    <div className="detail-header" style={{background:'linear-gradient(135deg, var(--primary), #4285f4)'}}>
                        <div style={{fontSize:12,opacity:0.8}}>{modal.item.brand}</div>
                        <div style={{fontSize:20,fontWeight:600}}>{modal.item.model}</div>
                        <div className="detail-price">${modal.item.price}</div>
                        <div style={{fontSize:14,opacity:0.8,textDecoration:'line-through'}}>MSRP ${modal.item.msrp}</div>
                    </div>
                    <div className="commission-box">
                        <div>
                            <div style={{fontSize:12,color:'var(--gray-500)'}}>Commission ({commissionRates[modal.item.condition]}%)</div>
                            <div style={{fontSize:13}}>{conditionLabels[modal.item.condition]}</div>
                        </div>
                        <div style={{fontSize:20,fontWeight:700,color:'#2e7d32'}}>+${(modal.item.price * commissionRates[modal.item.condition] / 100).toFixed(2)}</div>
                    </div>
                    <div className="info-row"><span>Description:</span><span>{modal.item.desc}</span></div>
                    <div className="info-row"><span>Category:</span><span>{modal.item.category}</span></div>
                    <div className="info-row"><span>Serial:</span><span>{modal.item.serial}</span></div>
                    <div className="info-row"><span>Location:</span><span>{getLocation(modal.item.location)?.name}</span></div>
                    <div className="info-row"><span>Color:</span><span>{modal.item.color}</span></div>
                    <div className="info-row"><span>Savings:</span><span style={{color:'var(--success)'}}>${modal.item.msrp - modal.item.price} ({Math.round((1 - modal.item.price/modal.item.msrp) * 100)}% off)</span></div>
                </Modal>
            )}

            {modal?.type === 'requestTransfer' && (
                <Modal title="Request Transfer" onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                        createTransferRequest({
                            inventoryId: modal.item.id,
                            toLocation: document.getElementById('trToLocation').value,
                            reason: document.getElementById('trReason').value,
                            neededBy: document.getElementById('trNeededBy').value
                        });
                    }}><i className="fas fa-paper-plane"></i> Submit Request</button>
                }>
                    <div className="alert alert-info">
                        <i className="fas fa-cube"></i>
                        <div><strong>{modal.item.brand} {modal.item.model}</strong><br/>Currently at: {getLocation(modal.item.location)?.name}</div>
                    </div>
                    <FormInput label="Transfer To" id="trToLocation" type="select">
                        {data.locations.filter(l => l.id !== modal.item.location).map(l => (
                            <option key={l.id} value={l.id}>{l.name}</option>
                        ))}
                    </FormInput>
                    <FormInput label="Reason" id="trReason" type="textarea" placeholder="Why is this transfer needed?" />
                    <FormInput label="Needed By" id="trNeededBy" type="date" />
                </Modal>
            )}

            {modal?.type === 'orderDetail' && (
                <Modal title={modal.order.number} onClose={() => setModal(null)} footer={
                    !modal.order.paid ? (
                        <button className="btn btn-success" style={{flex:1}} onClick={() => { markOrderPaid(modal.order.id); setModal(null); }}>
                            <i className="fas fa-dollar-sign"></i> Record Payment
                        </button>
                    ) : modal.order.status === 'Pending Delivery' ? (
                        <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                            const dr = { id: `del${Date.now()}`, orderId: modal.order.id, customerId: modal.order.customerId, requestedBy: currentUser.id, date: new Date().toISOString().split('T')[0], neededBy: '', status: 'Pending', type: modal.order.deliveryType, haulAway: false, notes: modal.order.notes, timeWindow: 'Anytime' };
                            setData(d => ({ ...d, deliveryRequests: [...d.deliveryRequests, dr] }));
                            addActivity('Delivery Requested', 'Delivery', dr.id, `For ${modal.order.number}`);
                            showToast('Delivery request created');
                            setModal(null);
                        }}><i className="fas fa-truck"></i> Request Delivery</button>
                    ) : null
                }>
                    <div className="alert" style={{background: modal.order.paid ? '#e8f5e9' : '#fff8e1', color: modal.order.paid ? '#2e7d32' : '#f57f17'}}>
                        <i className={`fas fa-${modal.order.paid ? 'check-circle' : 'clock'}`}></i>
                        {modal.order.paid ? 'Paid' : 'Payment Pending'}
                    </div>
                    <div className="info-row"><span>Customer:</span><span>{getCustomer(modal.order.customerId)?.name}</span></div>
                    <div className="info-row"><span>Phone:</span><span>{getCustomer(modal.order.customerId)?.phone}</span></div>
                    <div className="info-row"><span>Date:</span><span>{modal.order.date}</span></div>
                    <div className="info-row"><span>Delivery:</span><span>{modal.order.deliveryType}</span></div>
                    <div className="info-row"><span>Status:</span><StatusBadge status={modal.order.status} /></div>
                    
                    <div style={{marginTop:16,paddingTop:16,borderTop:'1px solid var(--gray-200)'}}>
                        <strong>Items:</strong>
                        {modal.order.items.map(invId => {
                            const inv = data.inventory.find(i => i.id === invId);
                            return inv && (
                                <div key={invId} style={{padding:'8px 0', borderBottom:'1px solid var(--gray-100)', display:'flex', justifyContent:'space-between'}}>
                                    <span>{inv.brand} {inv.model}</span>
                                    <span>${inv.price}</span>
                                </div>
                            );
                        })}
                    </div>
                    <div style={{marginTop:16}}>
                        <div className="info-row"><span>Subtotal:</span><span>${modal.order.subtotal.toFixed(2)}</span></div>
                        <div className="info-row"><span>Tax:</span><span>${modal.order.tax.toFixed(2)}</span></div>
                        <div className="info-row"><span>Delivery:</span><span>${modal.order.deliveryFee}</span></div>
                        <div className="info-row" style={{fontWeight:700,fontSize:18}}><span>Total:</span><span>${modal.order.total.toFixed(2)}</span></div>
                    </div>
                    {modal.order.notes && <div style={{marginTop:16,padding:12,background:'var(--gray-100)',borderRadius:8}}><strong>Notes:</strong> {modal.order.notes}</div>}
                </Modal>
            )}

            {modal?.type === 'customerDetail' && (
                <Modal title="Customer Details" onClose={() => setModal(null)} footer={
                    <><button className="btn btn-outline" style={{flex:1}} onClick={() => setModal({ type: 'editCustomer', customer: modal.customer })}><i className="fas fa-edit"></i> Edit</button>
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => { setSelectedCustomer(modal.customer); setModal(null); setView('inventory'); showToast(`Selected: ${modal.customer.name}`); }}><i className="fas fa-check"></i> Select</button></>
                }>
                    <div className="info-row"><span>Name:</span><span>{modal.customer.name}</span></div>
                    <div className="info-row"><span>Phone:</span><span>{modal.customer.phone}</span></div>
                    <div className="info-row"><span>Email:</span><span>{modal.customer.email || '-'}</span></div>
                    <div className="info-row"><span>Address:</span><span>{modal.customer.address || '-'}</span></div>
                    <div style={{marginTop:16}}>
                        <strong>Order History:</strong>
                        {data.orders.filter(o => o.customerId === modal.customer.id).map(order => (
                            <div key={order.id} className="list-item" style={{padding:'8px 0'}}>
                                <div className="list-content">
                                    <div className="list-title">{order.number}</div>
                                    <div className="list-subtitle">{order.date}</div>
                                </div>
                                <div className="list-meta">
                                    <div className="list-price">${order.total.toFixed(2)}</div>
                                    <StatusBadge status={order.status} />
                                </div>
                            </div>
                        ))}
                    </div>
                </Modal>
            )}

            {(modal === 'newCustomer' || modal?.type === 'editCustomer') && (
                <Modal title={modal === 'newCustomer' ? 'New Customer' : 'Edit Customer'} onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                        const formData = {
                            name: document.getElementById('custName').value,
                            phone: document.getElementById('custPhone').value,
                            email: document.getElementById('custEmail').value,
                            address: document.getElementById('custAddress').value
                        };
                        if (modal === 'newCustomer') createCustomer(formData);
                        else updateCustomer(modal.customer.id, formData);
                    }}><i className="fas fa-check"></i> {modal === 'newCustomer' ? 'Create' : 'Save'}</button>
                }>
                    <FormInput label="Name" id="custName" required defaultValue={modal?.customer?.name || ''} />
                    <FormInput label="Phone" id="custPhone" required defaultValue={modal?.customer?.phone || ''} />
                    <FormInput label="Email" id="custEmail" type="email" defaultValue={modal?.customer?.email || ''} />
                    <FormInput label="Address" id="custAddress" type="textarea" defaultValue={modal?.customer?.address || ''} />
                </Modal>
            )}

            {/* ADMIN APP MODALS */}
            {modal?.type === 'userDetail' && (
                <Modal title="User Details" onClose={() => setModal(null)} footer={
                    <><button className="btn btn-outline" style={{flex:1}} onClick={() => setModal({ type: 'editUser', user: modal.user })}><i className="fas fa-edit"></i> Edit</button>
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => { setSelectedCustomer(modal.customer); setModal(null); setView('inventory'); showToast(`Selected: ${modal.customer.name}`); }}><i className="fas fa-check"></i> Select</button></>
                }>
                    <div className="info-row"><span>Name:</span><span>{modal.user.name}</span></div>
                    <div className="info-row"><span>Email:</span><span>{modal.user.email}</span></div>
                    <div className="info-row"><span>Phone:</span><span>{modal.user.phone}</span></div>
                    <div className="info-row"><span>Role:</span><span>{modal.user.role}</span></div>
                    <div className="info-row"><span>Location:</span><span>{getLocation(modal.user.location)?.name}</span></div>
                </Modal>
            )}

            {(modal === 'newUser' || modal?.type === 'editUser') && (
                <Modal title={modal === 'newUser' ? 'New User' : 'Edit User'} onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                        const formData = { name: document.getElementById('userName').value, email: document.getElementById('userEmail').value, phone: document.getElementById('userPhone').value, role: document.getElementById('userRole').value, location: document.getElementById('userLocation').value };
                        if (!formData.name) return showToast('Name required');
                        if (modal === 'newUser') createUser(formData);
                        else updateUser(modal.user.id, formData);
                    }}><i className="fas fa-check"></i> {modal === 'newUser' ? 'Create' : 'Save'}</button>
                }>
                    <FormInput label="Name" id="userName" required defaultValue={modal?.user?.name || ''} />
                    <FormInput label="Email" id="userEmail" type="email" required defaultValue={modal?.user?.email || ''} />
                    <FormInput label="Phone" id="userPhone" defaultValue={modal?.user?.phone || ''} />
                    <FormInput label="Role" id="userRole" type="select" defaultValue={modal?.user?.role || 'Sales'}>
                        <option>Admin</option><option>Sales</option><option>Warehouse</option><option>Driver</option><option>Technician</option>
                    </FormInput>
                    <FormInput label="Location" id="userLocation" type="select" defaultValue={modal?.user?.location || 'loc1'}>
                        {data.locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                    </FormInput>
                </Modal>
            )}

            {modal?.type === 'workOrderDetail' && (
                <Modal title={modal.wo.number} onClose={() => setModal(null)} footer={
                    modal.wo.status === 'Pending' ? (
                        <button className="btn btn-primary" style={{flex:1}} onClick={() => setModal({ type: 'scheduleWO', wo: modal.wo })}><i className="fas fa-calendar"></i> Schedule</button>
                    ) : modal.wo.status === 'Scheduled' || modal.wo.status === 'Parts Ordered' ? (
                        <button className="btn btn-success" style={{flex:1}} onClick={() => { completeWorkOrder(modal.wo.id); setModal(null); }}><i className="fas fa-check"></i> Complete</button>
                    ) : null
                }>
                    <div className="info-row"><span>Customer:</span><span>{getCustomer(modal.wo.customerId)?.name}</span></div>
                    <div className="info-row"><span>Type:</span><span>{modal.wo.type}</span></div>
                    <div className="info-row"><span>Problem:</span><span>{modal.wo.problem}</span></div>
                    <div className="info-row"><span>Technician:</span><span>{getUser(modal.wo.technicianId)?.name}</span></div>
                    <div className="info-row"><span>Scheduled:</span><span>{modal.wo.scheduledDate}</span></div>
                    <div className="info-row"><span>Status:</span><StatusBadge status={modal.wo.status} /></div>
                    {modal.wo.notes && <div style={{marginTop:16,padding:12,background:'var(--gray-100)',borderRadius:8}}><strong>Notes:</strong> {modal.wo.notes}</div>}
                </Modal>
            )}

            {modal?.type === 'scheduleWO' && (
                <Modal title="Schedule Work Order" onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => scheduleWorkOrder(modal.wo.id)}><i className="fas fa-calendar-check"></i> Schedule</button>
                }>
                    <FormInput label="Scheduled Date" id="scheduleDate" type="date" required defaultValue={modal.wo.scheduledDate} />
                </Modal>
            )}

            {modal?.type === 'exchangeDetail' && (
                <Modal title={modal.ex.number} onClose={() => setModal(null)} footer={
                    modal.ex.status !== 'Complete' && (
                        <button className="btn btn-primary" style={{flex:1}} onClick={() => { completeExchange(modal.ex.id); setModal(null); }}><i className="fas fa-check"></i> Complete</button>
                    )
                }>
                    <div className="info-row"><span>Customer:</span><span>{getCustomer(modal.ex.customerId)?.name}</span></div>
                    <div className="info-row"><span>Reason:</span><span>{modal.ex.reason}</span></div>
                    <div className="info-row"><span>Original Item:</span><span>{getInventory(modal.ex.originalInventoryId)?.brand}</span></div>
                    {modal.ex.replacementInventoryId && <div className="info-row"><span>Replacement:</span><span>{getInventory(modal.ex.replacementInventoryId)?.brand}</span></div>}
                    <div className="info-row"><span>Price Adjustment:</span><span style={{color: modal.ex.priceDifference > 0 ? 'var(--danger)' : 'var(--success)'}}>${modal.ex.priceDifference}</span></div>
                    <div className="info-row"><span>Status:</span><StatusBadge status={modal.ex.status} /></div>
                </Modal>
            )}

            {modal?.type === 'returnDetail' && (
                <Modal title={modal.ret.number} onClose={() => setModal(null)} footer={
                    modal.ret.status === 'Pending Approval' && (
                        <><button className="btn btn-outline" style={{flex:1}} onClick={() => { rejectCustomOrder(modal.ret.id, 'Return Rejected'); setModal(null); }}>Reject</button>
                        <button className="btn btn-success" style={{flex:1}} onClick={() => { approveReturn(modal.ret.id); setModal(null); }}>Approve</button></>
                    )
                }>
                    <div className="info-row"><span>Customer:</span><span>{getCustomer(modal.ret.customerId)?.name}</span></div>
                    <div className="info-row"><span>Reason:</span><span>{modal.ret.reason}</span></div>
                    <div className="info-row"><span>Original Price:</span><span>${modal.ret.originalPrice.toFixed(2)}</span></div>
                    <div className="info-row"><span>Restocking Fee ({modal.ret.restockingPercent}%):</span><span style={{color:'var(--danger)'}}>${modal.ret.restockingFee.toFixed(2)}</span></div>
                    <div className="info-row" style={{fontWeight:700}}><span>Refund Amount:</span><span style={{color:'var(--success)'}}>${modal.ret.refundAmount.toFixed(2)}</span></div>
                    <div className="info-row"><span>Can Resell:</span><span>{modal.ret.canResell ? 'Yes' : 'No'}</span></div>
                    <div className="info-row"><span>Status:</span><StatusBadge status={modal.ret.status} /></div>
                </Modal>
            )}

            {modal === 'menu' && (
                <Modal title="Create New" onClose={() => setModal(null)}>
                    <button className="btn btn-primary btn-block" style={{marginBottom:8}} onClick={() => setModal('newWorkOrder')}><i className="fas fa-plus"></i> Work Order</button>
                    <button className="btn btn-primary btn-block" style={{marginBottom:8}} onClick={() => setModal('newReturn')}><i className="fas fa-plus"></i> Return</button>
                </Modal>
            )}

            {modal === 'newWorkOrder' && (
                <Modal title="New Work Order" onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                        createWorkOrder({
                            customerId: document.getElementById('woCustId').value,
                            orderId: document.getElementById('woOrderId').value,
                            inventoryId: document.getElementById('woInvId').value,
                            type: document.getElementById('woType').value,
                            problem: document.getElementById('woProblem').value,
                            technicianId: document.getElementById('woTech').value,
                            scheduledDate: document.getElementById('woSchedule').value,
                            notes: document.getElementById('woNotes').value
                        });
                    }}><i className="fas fa-check"></i> Create</button>
                }>
                    <FormInput label="Customer" id="woCustId" type="select" required>
                        {data.customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    </FormInput>
                    <FormInput label="Order" id="woOrderId" type="select">
                        {data.orders.map(o => <option key={o.id} value={o.id}>{o.number}</option>)}
                    </FormInput>
                    <FormInput label="Item" id="woInvId" type="select" required>
                        {data.inventory.map(i => <option key={i.id} value={i.id}>{i.brand} {i.model}</option>)}
                    </FormInput>
                    <FormInput label="Type" id="woType" type="select" required>
                        <option>Warranty Repair</option><option>Maintenance</option><option>Installation</option>
                    </FormInput>
                    <FormInput label="Problem Description" id="woProblem" type="textarea" required placeholder="Describe the issue..." />
                    <FormInput label="Technician" id="woTech" type="select" required>
                        {data.users.filter(u => u.role === 'Technician').map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                    </FormInput>
                    <FormInput label="Scheduled Date" id="woSchedule" type="date" />
                    <FormInput label="Notes" id="woNotes" type="textarea" />
                </Modal>
            )}

            {modal === 'newReturn' && (
                <Modal title="New Return" onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                        createReturn({
                            customerId: document.getElementById('retCustId').value,
                            orderId: document.getElementById('retOrderId').value,
                            inventoryId: document.getElementById('retInvId').value,
                            reason: document.getElementById('retReason').value,
                            originalPrice: document.getElementById('retPrice').value,
                            canResell: document.getElementById('retCanResell').value,
                            notes: document.getElementById('retNotes').value
                        });
                    }}><i className="fas fa-check"></i> Create</button>
                }>
                    <FormInput label="Customer" id="retCustId" type="select" required>
                        {data.customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    </FormInput>
                    <FormInput label="Order" id="retOrderId" type="select" required>
                        {data.orders.map(o => <option key={o.id} value={o.id}>{o.number}</option>)}
                    </FormInput>
                    <FormInput label="Item" id="retInvId" type="select" required>
                        {data.inventory.map(i => <option key={i.id} value={i.id}>{i.brand} {i.model}</option>)}
                    </FormInput>
                    <FormInput label="Reason" id="retReason" type="select" required>
                        <option>Changed Mind</option><option>Defective</option><option>Damaged</option><option>Not as Described</option>
                    </FormInput>
                    <FormInput label="Original Price" id="retPrice" type="number" required />
                    <FormInput label="Can Resell" id="retCanResell" type="select">
                        <option value="true">Yes</option><option value="false">No</option>
                    </FormInput>
                    <FormInput label="Notes" id="retNotes" type="textarea" />
                </Modal>
            )}
        </div>
    );
};

// Add this before the App component (after WarrantyApp):

const AdminApp = () => {
    const { data, setData, showToast, addActivity } = useApp();
    const [view, setView] = useState('overview');
    const [modal, setModal] = useState(null);
    const [selectedPayrollWeek, setSelectedPayrollWeek] = useState(null);

    const getLocation = (id) => data.locations.find(l => l.id === id);
    const completedOrders = data.orders.filter(o => o.status === 'Complete');
    const totalRevenue = completedOrders.reduce((s, o) => s + o.total, 0);
    const totalCommissions = completedOrders.reduce((s, o) => s + o.items.reduce((sum, invId) => {
        const inv = data.inventory.find(i => i.id === invId);
        return sum + (inv ? inv.price * (commissionRates[inv.condition] || 10) / 100 : 0);
    }, 0), 0);
    
    const salesByUser = data.users.filter(u => u.role === 'Sales').map(user => {
        const orders = data.orders.filter(o => o.salesId === user.id && o.status === 'Complete');
        const revenue = orders.reduce((s, o) => s + o.total, 0);
        const commission = orders.reduce((s, o) => s + o.items.reduce((sum, invId) => {
            const inv = data.inventory.find(i => i.id === invId);
            return sum + (inv ? inv.price * (commissionRates[inv.condition] || 10) / 100 : 0);
        }, 0), 0);
        return { ...user, orderCount: orders.length, revenue, commission };
    }).sort((a, b) => b.commission - a.commission);

    const salesByLocation = data.locations.map(loc => {
        const orders = data.orders.filter(o => o.locationId === loc.id && o.status === 'Complete');
        const revenue = orders.reduce((s, o) => s + o.total, 0);
        return { ...loc, orders: orders.length, revenue };
    });

    // Payroll functions
    const getWeekNumber = (date) => {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    };

    const getWeekStartEnd = (weekNum, year = new Date().getFullYear()) => {
        const d = new Date(year, 0, 1);
        const dayNum = d.getDay() || 7;
        d.setDate(d.getDate() + 4 - dayNum);
        const weekStart = new Date(d.setDate(d.getDate() - (d.getDay() - 1) + (weekNum - 1) * 7));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        return { start: weekStart.toISOString().split('T')[0], end: weekEnd.toISOString().split('T')[0] };
    };

    const getWeeklyPayroll = (weekNum, year = new Date().getFullYear()) => {
        const { start, end } = getWeekStartEnd(weekNum, year);
        const weekOrders = data.orders.filter(o => {
            const orderDate = o.date;
            return o.status === 'Complete' && orderDate >= start && orderDate <= end;
        });

        const payrollByRep = {};
        weekOrders.forEach(order => {
            if (!payrollByRep[order.salesId]) {
                const user = data.users.find(u => u.id === order.salesId);
                payrollByRep[order.salesId] = {
                    userId: order.salesId,
                    repName: user?.name || 'Unknown',
                    repEmail: user?.email || '',
                    repPhone: user?.phone || '',
                    orders: [],
                    totalCommission: 0,
                    totalRevenue: 0
                };
            }
            const commission = order.items.reduce((sum, invId) => {
                const inv = data.inventory.find(i => i.id === invId);
                return sum + (inv ? inv.price * (commissionRates[inv.condition] || 10) / 100 : 0);
            }, 0);
            payrollByRep[order.salesId].orders.push({ ...order, commission });
            payrollByRep[order.salesId].totalCommission += commission;
            payrollByRep[order.salesId].totalRevenue += order.total;
        });

        return { start, end, payrollByRep: Object.values(payrollByRep), weekOrders };
    };

    const generatePayrollPDF = (weekNum, year = new Date().getFullYear()) => {
        const { start, end, payrollByRep } = getWeeklyPayroll(weekNum, year);
        const totalCommission = payrollByRep.reduce((sum, rep) => sum + rep.totalCommission, 0);

        // Simple HTML to PDF conversion using print-friendly HTML
        const pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <title>Weekly Payroll Report - Week ${weekNum} ${year}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
        .header { text-align: center; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0; color: #1a73e8; }
        .header p { margin: 5px 0; color: #666; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background: #1a73e8; color: white; padding: 12px; text-align: left; font-weight: bold; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        tr:nth-child(even) { background: #f9f9f9; }
        .rep-section { page-break-inside: avoid; margin-bottom: 30px; border-left: 3px solid #1a73e8; padding-left: 15px; }
        .rep-name { font-size: 18px; font-weight: bold; color: #1a73e8; margin-bottom: 5px; }
        .rep-info { font-size: 12px; color: #666; margin-bottom: 10px; }
        .items-table { width: 100%; margin-top: 10px; }
        .items-table td { padding: 6px; font-size: 12px; }
        .items-table th { padding: 6px; background: #e3f2fd; color: #1a73e8; }
        .total-row { font-weight: bold; background: #e8f5e9; }
        .summary { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-top: 20px; }
        .summary-item { display: flex; justify-content: space-between; margin: 5px 0; }
        .footer { margin-top: 30px; font-size: 11px; color: #999; text-align: center; border-top: 1px solid #ddd; padding-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Weekly Commission Payroll Report</h1>
        <p>Week ${weekNum}, ${year} | Period: ${start} to ${end}</p>
        <p>Generated: ${new Date().toLocaleDateString()}</p>
    </div>

    ${payrollByRep.map((rep, idx) => `
        <div class="rep-section">
            <div class="rep-name">${idx + 1}. ${rep.repName}</div>
            <div class="rep-info">
                Email: ${rep.repEmail} | Phone: ${rep.repPhone} | Orders: ${rep.orders.length}
            </div>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Revenue</th>
                        <th>Commission</th>
                    </tr>
                </thead>
                <tbody>
                    ${rep.orders.map(order => `
                        <tr>
                            <td>${order.number}</td>
                            <td>${order.date}</td>
                            <td>${order.items.length}</td>
                            <td>$${order.total.toFixed(2)}</td>
                            <td>$${order.commission.toFixed(2)}</td>
                        </tr>
                    `).join('')}
                    <tr class="total-row">
                        <td colspan="3">Weekly Total</td>
                        <td>$${rep.totalRevenue.toFixed(2)}</td>
                        <td>$${rep.totalCommission.toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    `).join('')}

    <div class="summary">
        <h3 style="margin: 0 0 10px 0; color: #1a73e8;">Payroll Summary</h3>
        <div class="summary-item">
            <span>Total Sales Representatives:</span>
            <span><strong>${payrollByRep.length}</strong></span>
        </div>
        <div class="summary-item">
            <span>Total Orders Processed:</span>
            <span><strong>${payrollByRep.reduce((sum, rep) => sum + rep.orders.length, 0)}</strong></span>
        </div>
        <div class="summary-item">
            <span>Total Revenue (Week):</span>
            <span><strong>$${payrollByRep.reduce((sum, rep) => sum + rep.totalRevenue, 0).toFixed(2)}</strong></span>
        </div>
        <div class="summary-item" style="font-size: 16px; color: #2e7d32; border-top: 1px solid #90caf9; padding-top: 10px; margin-top: 10px;">
            <span>Total Commission Payout:</span>
            <span>$${totalCommission.toFixed(2)}</span>
        </div>
    </div>

    <div class="footer">
        <p>This is an automatically generated payroll report. Commission rates vary by item condition.</p>
        <p>Payment period: ${start} to ${end}</p>
    </div>
</body>
</html>
        `;

        // Open in new window for printing/saving
        const printWindow = window.open('', '', 'width=900,height=600');
        printWindow.document.write(pdfContent);
        printWindow.document.close();
        showToast('Payroll PDF opened - use print/save as PDF');
    };

    const downloadPayrollCSV = (weekNum, year = new Date().getFullYear()) => {
        const { start, end, payrollByRep } = getWeeklyPayroll(weekNum, year);
        
        let csv = `WEEKLY PAYROLL REPORT - Week ${weekNum}, ${year}\n`;
        csv += `Period: ${start} to ${end}\n`;
        csv += `Generated: ${new Date().toLocaleString()}\n\n`;

        csv += 'Sales Rep,Email,Phone,Orders,Total Revenue,Commission Rate (Avg),Total Commission\n';
        
        payrollByRep.forEach(rep => {
            const avgRate = rep.orders.length > 0 
                ? (rep.totalCommission / rep.totalRevenue * 100).toFixed(2) 
                : '0';
            csv += `"${rep.repName}","${rep.repEmail}","${rep.repPhone}",${rep.orders.length},$${rep.totalRevenue.toFixed(2)},${avgRate}%,$${rep.totalCommission.toFixed(2)}\n`;
        });

        csv += `\nTOTAL,$${payrollByRep.reduce((sum, rep) => sum + rep.totalRevenue, 0).toFixed(2)},,,$${payrollByRep.reduce((sum, rep) => sum + rep.totalCommission, 0).toFixed(2)}\n`;

        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv));
        element.setAttribute('download', `payroll_week${weekNum}_${year}.csv`);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
        showToast('CSV downloaded successfully');
    };

    const createUser = (formData) => {
        const newUser = { id: `u${Date.now()}`, ...formData };
        setData(d => ({ ...d, users: [...d.users, newUser] }));
        addActivity('User Created', 'User', newUser.id, newUser.name);
        setModal(null);
        showToast('User created');
    };

    const updateUser = (userId, formData) => {
        setData(d => ({ ...d, users: d.users.map(u => u.id === userId ? { ...u, ...formData } : u) }));
        addActivity('User Updated', 'User', userId, 'User updated');
        showToast('User updated');
        setModal(null);
    };

    return (
        <div>
            <div className="app-header" style={{background: '#1a1a2e'}}>
                <div className="list-icon" style={{background:'rgba(255,255,255,0.2)', color:'white'}}><i className="fas fa-chart-line"></i></div>
                <h1>Admin</h1>
            </div>

            <div className="inner-tabs">
                <button className={`inner-tab ${view === 'overview' ? 'active' : ''}`} onClick={() => setView('overview')}>Overview</button>
                <button className={`inner-tab ${view === 'payroll' ? 'active' : ''}`} onClick={() => setView('payroll')}>Payroll</button>
                <button className={`inner-tab ${view === 'users' ? 'active' : ''}`} onClick={() => setView('users')}>Users</button>
                <button className={`inner-tab ${view === 'activity' ? 'active' : ''}`} onClick={() => setView('activity')}>Activity</button>
            </div>

            <div className="app-content">
                {view === 'overview' && (
                    <>
                        <div className="stats-grid">
                            <div className="stat-card"><div className="stat-value">${(totalRevenue/1000).toFixed(1)}K</div><div className="stat-label">Revenue</div></div>
                            <div className="stat-card"><div className="stat-value">${(totalCommissions/1000).toFixed(1)}K</div><div className="stat-label">Commissions</div></div>
                            <div className="stat-card"><div className="stat-value">{completedOrders.length}</div><div className="stat-label">Orders</div></div>
                            <div className="stat-card"><div className="stat-value">{data.customers.length}</div><div className="stat-label">Customers</div></div>
                        </div>

                        <div className="section-header">Top Salespeople</div>
                        <div className="card">
                            {salesByUser.slice(0, 5).map((user, idx) => (
                                <div key={user.id} className="list-item">
                                    <div className="list-icon" style={{background:idx===0?'#fff8e1':'#f5f5f5',color:idx===0?'#f57f17':'var(--gray-500)'}}><i className={`fas fa-${idx===0?'trophy':idx===1?'medal':'user'}`}></i></div>
                                    <div className="list-content">
                                        <div className="list-title">{user.name}</div>
                                        <div className="list-subtitle">{user.orderCount} order(s) • ${user.revenue.toFixed(0)}</div>
                                    </div>
                                    <div className="list-price" style={{color:'var(--success)'}}>${user.commission.toFixed(2)}</div>
                                </div>
                            ))}
                        </div>
                    </>
                )}

                {view === 'payroll' && (() => {
                    const currentWeek = getWeekNumber(new Date());
                    const currentYear = new Date().getFullYear();
                    const weekToShow = selectedPayrollWeek || currentWeek;
                    const { start, end, payrollByRep, weekOrders } = getWeeklyPayroll(weekToShow, currentYear);
                    const totalWeeklyCommission = payrollByRep.reduce((sum, rep) => sum + rep.totalCommission, 0);
                    const totalWeeklyRevenue = payrollByRep.reduce((sum, rep) => sum + rep.totalRevenue, 0);

                    return (
                        <>
                            <div style={{padding:12,background:'var(--gray-100)',borderBottom:'1px solid var(--gray-300)'}}>
                                <div style={{fontSize:12,fontWeight:600,marginBottom:12,color:'var(--gray-700)'}}>
                                    <i className="fas fa-calendar"></i> Select Pay Period
                                </div>
                                <div style={{display:'flex',gap:8,marginBottom:12}}>
                                    <select 
                                        className="form-select"
                                        value={weekToShow}
                                        onChange={e => setSelectedPayrollWeek(parseInt(e.target.value))}
                                        style={{flex:1}}
                                    >
                                        {Array.from({length: 52}, (_, i) => i + 1).reverse().map(week => (
                                            <option key={week} value={week}>
                                                Week {week} {week === currentWeek ? '(Current)' : ''}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div style={{fontSize:11,color:'var(--gray-500)',marginBottom:12}}>
                                    <i className="fas fa-info-circle"></i> Period: {start} to {end} • {weekOrders.length} orders
                                </div>
                                <div style={{display:'flex',gap:8}}>
                                    <button 
                                        className="btn btn-primary btn-sm" 
                                        onClick={() => generatePayrollPDF(weekToShow, currentYear)}
                                        style={{flex:1}}
                                    >
                                        <i className="fas fa-file-pdf"></i> View PDF Report
                                    </button>
                                    <button 
                                        className="btn btn-outline btn-sm" 
                                        onClick={() => downloadPayrollCSV(weekToShow, currentYear)}
                                        style={{flex:1}}
                                    >
                                        <i className="fas fa-download"></i> Download CSV
                                    </button>
                                </div>
                            </div>

                            <div className="stats-grid" style={{marginTop:12}}>
                                <div className="stat-card">
                                    <div className="stat-value" style={{color:'var(--primary)'}}>${(totalWeeklyRevenue/1000).toFixed(1)}K</div>
                                    <div className="stat-label">Week Revenue</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value" style={{color:'var(--success)'}}>${(totalWeeklyCommission/1000).toFixed(1)}K</div>
                                    <div className="stat-label">Week Commission</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value">{payrollByRep.length}</div>
                                    <div className="stat-label">Reps (Paid)</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value">{weekOrders.length}</div>
                                    <div className="stat-label">Orders</div>
                                </div>
                            </div>

                            <div className="section-header">Commission Details by Sales Rep</div>
                            {payrollByRep.length === 0 ? (
                                <div className="empty-state"><i className="fas fa-inbox"></i><p>No sales this period</p></div>
                            ) : (
                                <div>
                                    {payrollByRep.sort((a, b) => b.totalCommission - a.totalCommission).map((rep, idx) => (
                                        <div key={rep.userId} className="card" style={{marginBottom:12}}>
                                            <div style={{padding:12,background:idx===0?'#fff8e1':'var(--gray-100)',borderBottom:'1px solid var(--gray-200)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                                <div style={{flex:1}}>
                                                    <div style={{fontSize:14,fontWeight:600}}>{idx === 0 && <i className="fas fa-crown" style={{marginRight:8,color:'#f57f17'}}></i>}{rep.repName}</div>
                                                    <div style={{fontSize:11,color:'var(--gray-500)'}}>{rep.repEmail}</div>
                                                </div>
                                                <div style={{textAlign:'right'}}>
                                                    <div style={{fontSize:18,fontWeight:700,color:'var(--success)'}}>${rep.totalCommission.toFixed(2)}</div>
                                                    <div style={{fontSize:11,color:'var(--gray-500)'}}>{rep.orders.length} orders</div>
                                                </div>
                                            </div>
                                            <div style={{padding:12}}>
                                                <div style={{fontSize:12,marginBottom:12}}>
                                                    <div className="info-row">
                                                        <span>Total Revenue:</span>
                                                        <span>${rep.totalRevenue.toFixed(2)}</span>
                                                    </div>
                                                    <div className="info-row">
                                                        <span>Commission Rate (Avg):</span>
                                                        <span>{(rep.totalCommission / rep.totalRevenue * 100).toFixed(1)}%</span>
                                                    </div>
                                                    <div className="info-row">
                                                        <span>Orders:</span>
                                                        <span>{rep.orders.length}</span>
                                                    </div>
                                                </div>
                                                <div style={{fontSize:11,color:'var(--gray-500)',paddingTop:12,borderTop:'1px solid var(--gray-200)'}}>
                                                    <strong>Order Details:</strong>
                                                    {rep.orders.map(order => (
                                                        <div key={order.id} style={{display:'flex',justifyContent:'space-between',marginTop:4}}>
                                                            <span>{order.number} • {order.items.length} items</span>
                                                            <span>+${order.commission.toFixed(2)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    );
                })()}

                {view === 'users' && (
                    <>
                        <div className="section-header">
                            Users ({data.users.length})
                            <button className="btn btn-sm btn-primary" onClick={() => setModal('newUser')}><i className="fas fa-plus"></i></button>
                        </div>
                        <div className="card">
                            {data.users.map(user => (
                                <div key={user.id} className="list-item" onClick={() => setModal({ type: 'editUser', user })}>
                                    <div className="list-icon" style={{background:'#f3e5f5',color:'var(--purple)'}}><i className="fas fa-user"></i></div>
                                    <div className="list-content">
                                        <div className="list-title">{user.name}</div>
                                        <div className="list-subtitle">{user.email}</div>
                                    </div>
                                    <span className="badge badge-available">{user.role}</span>
                                </div>
                            ))}
                        </div>
                    </>
                )}

                {view === 'activity' && (
                    <>
                        <div className="section-header">Activity Log</div>
                        <div className="card">
                            {data.activityLog.slice(0, 20).map(act => (
                                <div key={act.id} className="list-item">
                                    <div className="list-content">
                                        <div className="list-title" style={{fontSize:13}}>{act.action}</div>
                                        <div className="list-subtitle">{act.details}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </>
                )}
            </div>

            <div className="bottom-nav">
                <button className={`nav-item ${view === 'overview' ? 'active' : ''}`} onClick={() => setView('overview')}><i className="fas fa-chart-pie"></i>Overview</button>
                <button className={`nav-item ${view === 'payroll' ? 'active' : ''}`} onClick={() => setView('payroll')}><i className="fas fa-dollar-sign"></i>Payroll</button>
                <button className={`nav-item ${view === 'users' ? 'active' : ''}`} onClick={() => setView('users')}><i className="fas fa-users"></i>Users</button>
                <button className={`nav-item ${view === 'activity' ? 'active' : ''}`} onClick={() => setView('activity')}><i className="fas fa-history"></i>Activity</button>
            </div>

            {(modal === 'newUser' || modal?.type === 'editUser') && (
                <Modal title={modal === 'newUser' ? 'New User' : 'Edit User'} onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                        const formData = { name: document.getElementById('userName').value, email: document.getElementById('userEmail').value, phone: document.getElementById('userPhone').value, role: document.getElementById('userRole').value, location: document.getElementById('userLocation').value };
                        if (!formData.name) return showToast('Name required');
                        if (modal === 'newUser') createUser(formData);
                        else updateUser(modal.user.id, formData);
                    }}><i className="fas fa-check"></i> {modal === 'newUser' ? 'Create' : 'Save'}</button>
                }>
                    <FormInput label="Name" id="userName" required defaultValue={modal?.user?.name || ''} />
                    <FormInput label="Email" id="userEmail" type="email" required defaultValue={modal?.user?.email || ''} />
                    <FormInput label="Phone" id="userPhone" defaultValue={modal?.user?.phone || ''} />
                    <FormInput label="Role" id="userRole" type="select" defaultValue={modal?.user?.role || 'Sales'}>
                        <option>Admin</option><option>Sales</option><option>Warehouse</option><option>Driver</option><option>Technician</option>
                    </FormInput>
                    <FormInput label="Location" id="userLocation" type="select" defaultValue={modal?.user?.location || 'loc1'}>
                        {data.locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                    </FormInput>
                </Modal>
            )}

            {modal?.type === 'workOrderDetail' && (
                <Modal title={modal.wo.number} onClose={() => setModal(null)} footer={
                    modal.wo.status === 'Pending' ? (
                        <button className="btn btn-primary" style={{flex:1}} onClick={() => setModal({ type: 'scheduleWO', wo: modal.wo })}><i className="fas fa-calendar"></i> Schedule</button>
                    ) : modal.wo.status === 'Scheduled' || modal.wo.status === 'Parts Ordered' ? (
                        <button className="btn btn-success" style={{flex:1}} onClick={() => { completeWorkOrder(modal.wo.id); setModal(null); }}><i className="fas fa-check"></i> Complete</button>
                    ) : null
                }>
                    <div className="info-row"><span>Customer:</span><span>{getCustomer(modal.wo.customerId)?.name}</span></div>
                    <div className="info-row"><span>Type:</span><span>{modal.wo.type}</span></div>
                    <div className="info-row"><span>Problem:</span><span>{modal.wo.problem}</span></div>
                    <div className="info-row"><span>Technician:</span><span>{getUser(modal.wo.technicianId)?.name}</span></div>
                    <div className="info-row"><span>Scheduled:</span><span>{modal.wo.scheduledDate}</span></div>
                    <div className="info-row"><span>Status:</span><StatusBadge status={modal.wo.status} /></div>
                    {modal.wo.notes && <div style={{marginTop:16,padding:12,background:'var(--gray-100)',borderRadius:8}}><strong>Notes:</strong> {modal.wo.notes}</div>}
                </Modal>
            )}

            {modal?.type === 'scheduleWO' && (
                <Modal title="Schedule Work Order" onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => scheduleWorkOrder(modal.wo.id)}><i className="fas fa-calendar-check"></i> Schedule</button>
                }>
                    <FormInput label="Scheduled Date" id="scheduleDate" type="date" required defaultValue={modal.wo.scheduledDate} />
                </Modal>
            )}

            {modal?.type === 'exchangeDetail' && (
                <Modal title={modal.ex.number} onClose={() => setModal(null)} footer={
                    modal.ex.status !== 'Complete' && (
                        <button className="btn btn-primary" style={{flex:1}} onClick={() => { completeExchange(modal.ex.id); setModal(null); }}><i className="fas fa-check"></i> Complete</button>
                    )
                }>
                    <div className="info-row"><span>Customer:</span><span>{getCustomer(modal.ex.customerId)?.name}</span></div>
                    <div className="info-row"><span>Reason:</span><span>{modal.ex.reason}</span></div>
                    <div className="info-row"><span>Original Item:</span><span>{getInventory(modal.ex.originalInventoryId)?.brand}</span></div>
                    {modal.ex.replacementInventoryId && <div className="info-row"><span>Replacement:</span><span>{getInventory(modal.ex.replacementInventoryId)?.brand}</span></div>}
                    <div className="info-row"><span>Price Adjustment:</span><span style={{color: modal.ex.priceDifference > 0 ? 'var(--danger)' : 'var(--success)'}}>${modal.ex.priceDifference}</span></div>
                    <div className="info-row"><span>Status:</span><StatusBadge status={modal.ex.status} /></div>
                </Modal>
            )}

            {modal?.type === 'returnDetail' && (
                <Modal title={modal.ret.number} onClose={() => setModal(null)} footer={
                    modal.ret.status === 'Pending Approval' && (
                        <><button className="btn btn-outline" style={{flex:1}} onClick={() => { rejectCustomOrder(modal.ret.id, 'Return Rejected'); setModal(null); }}>Reject</button>
                        <button className="btn btn-success" style={{flex:1}} onClick={() => { approveReturn(modal.ret.id); setModal(null); }}>Approve</button></>
                    )
                }>
                    <div className="info-row"><span>Customer:</span><span>{getCustomer(modal.ret.customerId)?.name}</span></div>
                    <div className="info-row"><span>Reason:</span><span>{modal.ret.reason}</span></div>
                    <div className="info-row"><span>Original Price:</span><span>${modal.ret.originalPrice.toFixed(2)}</span></div>
                    <div className="info-row"><span>Restocking Fee ({modal.ret.restockingPercent}%):</span><span style={{color:'var(--danger)'}}>${modal.ret.restockingFee.toFixed(2)}</span></div>
                    <div className="info-row" style={{fontWeight:700}}><span>Refund Amount:</span><span style={{color:'var(--success)'}}>${modal.ret.refundAmount.toFixed(2)}</span></div>
                    <div className="info-row"><span>Can Resell:</span><span>{modal.ret.canResell ? 'Yes' : 'No'}</span></div>
                    <div className="info-row"><span>Status:</span><StatusBadge status={modal.ret.status} /></div>
                </Modal>
            )}

            {modal === 'menu' && (
                <Modal title="Create New" onClose={() => setModal(null)}>
                    <button className="btn btn-primary btn-block" style={{marginBottom:8}} onClick={() => setModal('newWorkOrder')}><i className="fas fa-plus"></i> Work Order</button>
                    <button className="btn btn-primary btn-block" style={{marginBottom:8}} onClick={() => setModal('newReturn')}><i className="fas fa-plus"></i> Return</button>
                </Modal>
            )}

            {modal === 'newWorkOrder' && (
                <Modal title="New Work Order" onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                        createWorkOrder({
                            customerId: document.getElementById('woCustId').value,
                            orderId: document.getElementById('woOrderId').value,
                            inventoryId: document.getElementById('woInvId').value,
                            type: document.getElementById('woType').value,
                            problem: document.getElementById('woProblem').value,
                            technicianId: document.getElementById('woTech').value,
                            scheduledDate: document.getElementById('woSchedule').value,
                            notes: document.getElementById('woNotes').value
                        });
                    }}><i className="fas fa-check"></i> Create</button>
                }>
                    <FormInput label="Customer" id="woCustId" type="select" required>
                        {data.customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    </FormInput>
                    <FormInput label="Order" id="woOrderId" type="select">
                        {data.orders.map(o => <option key={o.id} value={o.id}>{o.number}</option>)}
                    </FormInput>
                    <FormInput label="Item" id="woInvId" type="select" required>
                        {data.inventory.map(i => <option key={i.id} value={i.id}>{i.brand} {i.model}</option>)}
                    </FormInput>
                    <FormInput label="Type" id="woType" type="select" required>
                        <option>Warranty Repair</option><option>Maintenance</option><option>Installation</option>
                    </FormInput>
                    <FormInput label="Problem Description" id="woProblem" type="textarea" required placeholder="Describe the issue..." />
                    <FormInput label="Technician" id="woTech" type="select" required>
                        {data.users.filter(u => u.role === 'Technician').map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                    </FormInput>
                    <FormInput label="Scheduled Date" id="woSchedule" type="date" />
                    <FormInput label="Notes" id="woNotes" type="textarea" />
                </Modal>
            )}

            {modal === 'newReturn' && (
                <Modal title="New Return" onClose={() => setModal(null)} footer={
                    <button className="btn btn-primary" style={{flex:1}} onClick={() => {
                        createReturn({
                            customerId: document.getElementById('retCustId').value,
                            orderId: document.getElementById('retOrderId').value,
                            inventoryId: document.getElementById('retInvId').value,
                            reason: document.getElementById('retReason').value,
                            originalPrice: document.getElementById('retPrice').value,
                            canResell: document.getElementById('retCanResell').value,
                            notes: document.getElementById('retNotes').value
                        });
                    }}><i className="fas fa-check"></i> Create</button>
                }>
                    <FormInput label="Customer" id="retCustId" type="select" required>
                        {data.customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    </FormInput>
                    <FormInput label="Order" id="retOrderId" type="select" required>
                        {data.orders.map(o => <option key={o.id} value={o.id}>{o.number}</option>)}
                    </FormInput>
                    <FormInput label="Item" id="retInvId" type="select" required>
                        {data.inventory.map(i => <option key={i.id} value={i.id}>{i.brand} {i.model}</option>)}
                    </FormInput>
                    <FormInput label="Reason" id="retReason" type="select" required>
                        <option>Changed Mind</option><option>Defective</option><option>Damaged</option><option>Not as Described</option>
                    </FormInput>
                    <FormInput label="Original Price" id="retPrice" type="number" required />
                    <FormInput label="Can Resell" id="retCanResell" type="select">
                        <option value="true">Yes</option><option value="false">No</option>
                    </FormInput>
                    <FormInput label="Notes" id="retNotes" type="textarea" />
                </Modal>
            )}
        </div>
    );
};

// Add missing functions to SchedulerApp - find the approveTransfer call and add these:
const approveTransfer = (id) => { /* function body */ };
const completeTransfer = (id) => { /* function body */ };

// ...existing code...
</script>
</body>
</html>
